# サンプルIssue: ユーザー認証機能の実装

## 🎯 目的 / 成功基準

### 目的
ユーザーが安全にログインできる認証システムを構築し、セキュアなセッション管理を実現する。

### 成功基準
- [ ] JWT認証の実装完了
- [ ] パスワードハッシュ化（bcrypt）実装
- [ ] セッション管理機能実装
- [ ] セキュリティテスト（OWASP Top 10）通過
- [ ] ユーザー登録・ログイン・ログアウトフロー完成
- [ ] エラーハンドリング実装
- [ ] ドキュメント作成完了

## 👤 担当（AIサービス/モデル/端末）

- **サービス**: Cursor + ClaudeCode
- **モデル**: GPT-4o + Sonnet-4
- **端末**: MainPC(Windows) / SubPC(MacBook)
- **証跡URL**: https://github.com/owner/repo/issues/123

## 📋 Plan

### 前提・制約・依存関係
- Node.js 18+ 環境
- Express.js フレームワーク使用
- PostgreSQL データベース
- 既存のユーザーモデル拡張

### 技術選定
- JWT: jsonwebtoken ライブラリ
- ハッシュ化: bcryptjs
- セッション: express-session + connect-redis
- バリデーション: joi

### 実装順序
1. パスワードハッシュ化機能
2. JWT生成・検証機能
3. 認証ミドルウェア
4. ログイン・ログアウトAPI
5. セッション管理
6. セキュリティテスト

## 🛠️ Do

### 実装手順
1. **パスワードハッシュ化実装**
   ```bash
   npm install bcryptjs
   # 実装: utils/password.js
   ```

2. **JWT認証実装**
   ```bash
   npm install jsonwebtoken
   # 実装: utils/jwt.js, middleware/auth.js
   ```

3. **認証API実装**
   ```bash
   # 実装: routes/auth.js
   # POST /auth/login
   # POST /auth/logout
   # POST /auth/register
   ```

4. **セッション管理実装**
   ```bash
   npm install express-session connect-redis
   # 実装: middleware/session.js
   ```

### ログ・成果物
- [実装ログ] 2025-09-15 14:00-18:00: 基本認証機能実装
- [成果物] `/src/auth/` ディレクトリ配下に認証関連ファイル
- [テスト] Jest テストケース 15件作成

## ✅ Check

### 結果・副作用・再現性

#### 実装結果
- ✅ JWT認証: 正常動作確認
- ✅ パスワードハッシュ化: セキュリティ要件満足
- ✅ セッション管理: Redis連携成功
- ✅ API エンドポイント: 全エンドポイント動作確認

#### パフォーマンステスト
```bash
# 負荷テスト結果
- ログイン処理: 平均 150ms
- JWT検証: 平均 5ms
- セッション取得: 平均 10ms
```

#### セキュリティテスト
- [ ] SQLインジェクション対策: 実装済み
- [ ] XSS対策: 実装済み
- [ ] CSRF対策: 実装済み
- [ ] ブルートフォース攻撃対策: 実装済み

### 副作用
- 既存APIの認証必須化により、一部クライアントでエラー発生
- セッションストレージとしてRedis追加により、インフラコスト増加

## 🔄 Act

### 是正・ルール反映・派生Issue

#### 是正アクション
1. **既存API互換性**: 認証オプション追加（Issue #124）
2. **コスト最適化**: Redis使用量監視設定（Issue #125）
3. **ドキュメント更新**: API仕様書更新（Issue #126）

#### ルール反映
- 新規API開発時は認証機能を必須とする
- パスワード要件: 8文字以上、英数字記号含む
- セッション有効期限: 24時間

#### 派生Issue
- [ ] Issue #127: 多要素認証(MFA)実装
- [ ] Issue #128: パスワードリセット機能
- [ ] Issue #129: 管理者権限システム

## 🧠 PIMS気づき（knowledge.mdc反映）

### 気づき
1. **JWT vs セッション**: 両方併用することで柔軟性向上
2. **パスワード要件**: ユーザビリティとセキュリティのバランス重要
3. **エラーハンドリング**: セキュリティ情報漏洩防止のため、詳細エラーは隠蔽

### 根拠(Evidence)
- セキュリティテスト結果: OWASP Top 10 全てクリア
- パフォーマンステスト: 要件内での応答時間達成
- ユーザーテスト: 認証フロー 95% 成功率

### 反映リンク
- `.cursor/rules/knowledge.mdc` に追加
- チーム共有ドキュメント更新
- 開発ガイドライン反映
